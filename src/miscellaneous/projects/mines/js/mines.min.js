$(function(){"use strict";var e={firstClick:true,gameover:false,canvas:null,context:null,totalMines:0,totalFlags:0,elapsedTime:0,clock:"",restart:"",mineMap:"",flagMap:"",revealedMap:"",currentAnimation:"",previous:new Array(2),squaresX:"",squaresY:""},t={difficulty:0,celSize:20,width:600,height:400,background:"white",font:"14px Arial",celColor:"#dadada",celStroke:"white",celRadius:5,mineImg:"images/mine.png",flagImg:"images/flag.png"},n={};var r={init:function(){e.canvas=$("#board");e.context=e.canvas[0].getContext("2d");e.context.background=t.background;var s=this.hiDPIRatio();if(s!==1){var u=e.canvas[0].width;var a=e.canvas[0].height;e.canvas[0].width=u*s;e.canvas[0].height=a*s;e.canvas.css({width:u+"px",height:a+"px"});e.context.scale(s,s)}e.context.font=t.font;t.width=e.canvas.width();e.squaresX=Math.floor(t.width/t.celSize);e.squaresY=Math.floor(t.height/t.celSize);e.mineMap=new Array(e.squaresX);e.flagMap=new Array(e.squaresX);e.revealedMap=new Array(e.squaresX);n.flags=$("#flags");n.mines=$("#mines");n.status=$("#status");n.time=$("#time");n.msg=$("#msg");n.scoreboard=$("#scoreboard");n.easy=$("#easybtn");n.medium=$("#mediumbtn");n.insane=$("#insanebtn");n.switchscreens=$("#switchscreens");n.reset=$("#reset");n.save=$("#save");n.load=$("#load");n.upload=$("#upload");var f={9:n.easy,6:n.medium,3:n.insane};$.each(f,function(e,n){n.on({click:function(){t.difficulty=e;o.switchScreens()}})});n.switchscreens.on({click:function(){o.switchScreens()}});n.reset.on({click:function(){r.reset()}});n.save.on({click:function(){if(t.difficulty==0){alert("Game not started yet!")}else if(e.gameover){alert("Game Over!")}else o.save()}});n.load.on({click:function(){n.upload.click()}});n.upload.on({click:function(e){this.value=null},change:function(e){o.load(e)}});$(".gamescreen").hide();e.canvas.on({mouseup:function(e){i.click(e)},mousemove:function(e){i.hover(e)}});var l=new Array;l[0]=new Image;l[0].src=t.mineImg;l[1]=new Image;l[1].src=t.flagImg;r.setup()},hiDPIRatio:function(){var t,n;t=window.devicePixelRatio||1;n=e.context.webkitBackingStorePixelRatio||e.context.mozBackingStorePixelRatio||e.context.msBackingStorePixelRatio||e.context.oBackingStorePixelRatio||e.context.backingStorePixelRatio||1;return t/n},reset:function(){window.clearInterval(e.clock);window.clearInterval(e.restart);e.context.clearRect(0,0,t.width,t.height);e.gameover=false;e.firstClick=true;e.totalMines=0;e.totalFlags=0;e.elapsedTime=0;e.mineMap=new Array(e.squaresX);e.flagMap=new Array(e.squaresX);e.revealedMap=new Array(e.squaresX);n.flags.html("");n.mines.html("");n.status.html("Game on :)");n.time.html("0");n.msg.html("Click on a square to start the game!");r.setup();window.clearInterval(e.currentAnimation);s.walker()},setup:function(){for(var n=0;n<e.squaresX;n++){e.flagMap[n]=Array(e.squaresY);e.revealedMap[n]=Array(e.squaresY)}e.context.strokeStyle=t.celStroke;e.context.fillStyle=t.celColor;s.standardBoard()},timer:function(){e.clock=setInterval(function(){e.elapsedTime++;n.time.html(e.elapsedTime)},1e3)}};var i={click:function(u){if(e.gameover){return false}var a,f,l;a=Math.floor((u.pageX-e.canvas[0].offsetLeft-1)/t.celSize);f=Math.floor((u.pageY-e.canvas[0].offsetTop-1)/t.celSize);l=e.revealedMap[a][f]?1:-1;if(u.which===1&&e.flagMap[a][f]!==1&&t.difficulty!==0){if(e.firstClick===true){window.clearInterval(e.currentAnimation);s.standardBoard();r.timer();do{i.generateMines(e.mineMap)}while(e.mineMap[a][f]===-1);n.mines.html("You have to find "+e.totalMines+" mines to win.");e.firstClick=false}i.index(a,f)}else if(u.which===3&&o.is("revealed",a,f)){var c=0,h=new Array,p=[a,a+1,a-1],d=[f,f+1,f-1];for(var v=0;v<3;v++){for(var m=0;m<3;m++){if(o.is("flag",p[v],d[m])){c++}else{h.push([p[v],d[m]])}}}if(c===e.mineMap[a][f]){$.each(h,function(){i.index(this[0],this[1])})}}else if(u.which===3&&l<0&&e.firstClick!==true){var g=new Image;g.src=t.flagImg;g.onload=function(){i.flag(g,a,f)}}},hover:function(n){if(!e.gameover){var r=Math.floor((n.pageX-e.canvas[0].offsetLeft-1)/t.celSize),i=Math.floor((n.pageY-e.canvas[0].offsetTop-1)/t.celSize),s=e.revealedMap[r][i]?1:-1,u=e.flagMap[r][i]?1:-1;var a=e.previous[0],f=e.previous[1];if(typeof a!=="undefined"&&e.revealedMap[a][f]!==1&&e.flagMap[a][f]!==1){e.context.fillStyle=t.celColor;o.roundRect(e.previous[0],e.previous[1])}if(s<0&&u<0&&!e.firstClick){e.context.fillStyle="#aaa";o.roundRect(r,i);e.previous[0]=r;e.previous[1]=i}}},index:function(n,r){if(n>=0&&r>=0&&n<=e.squaresX&&r<=e.squaresY&&e.mineMap[n]!==undefined){var s=e.revealedMap[n][r]?1:-1;if(!o.is("revealed",n,r)){e.revealedMap[n][r]=1;if(e.mineMap[n][r]!==-1){var u=.1,a=setInterval(function(){e.context.strokeStyle="white";e.context.fillStyle="rgba(255,255,255,"+u+")";o.roundRect(n,r);if(e.mineMap[n][r]!==-1){var i=["none","blue","green","red","black","orange","cyan"];e.context.fillStyle=i[e.mineMap[n][r]];e.context.fillText(e.mineMap[n][r],n*t.celSize+5,r*t.celSize+16)}u=u+.1;if(u>1){window.clearInterval(a)}},50)}else{var f=new Image;f.src=t.mineImg;f.onload=function(){i.revealMines(f)}}if(e.mineMap[n][r]===0){for(var l=-1;l<=1;l++){for(var c=-1;c<=1;c++){if(s<0&&n+l>=0&&r+c>=0&&n+l<=e.squaresX&&r+c<=e.squaresX){i.index(n+l,r+c)}}}}}}},flag:function(r,s,u){if(e.flagMap[s][u]!==1){e.context.drawImage(r,s*t.celSize,u*t.celSize,t.celSize,t.celSize);e.flagMap[s][u]=1;e.totalFlags++}else{var a=e.context.createImageData(t.celSize,t.celSize);for(var f=a.data.length;--f>=0;){a.data[f]=0}e.context.putImageData(a,s*t.celSize,u*t.celSize);e.context.strokeStyle=t.celStroke;e.context.fillStyle=t.celColor;o.roundRect(s,u);e.flagMap[s][u]=0;e.totalFlags--}n.mines.html("You have to find "+(e.totalMines-e.totalFlags)+" mines to win.");n.flags.html("You have set "+e.totalFlags+" flags.");i.won()},won:function(){var t=0;for(var r=0;r<e.squaresX;r++){for(var i=0;i<e.squaresY;i++){if(e.flagMap[r][i]===1&&e.mineMap[r][i]===-1){t++}}}if(t===e.totalMines){e.gameover=true;n.status.html("You won! :D");window.clearInterval(e.clock)}},generateMines:function(){for(var n=0;n<e.squaresX;n++){e.mineMap[n]=new Array(e.squaresX);for(var r=0;r<e.squaresY;r++){e.mineMap[n][r]=Math.floor(Math.random()*t.difficulty-1);if(e.mineMap[n][r]>0){e.mineMap[n][r]=0}}}i.calculateMines()},calculateMines:function(){var t=0;e.totalMines=0;for(var n=0;n<e.squaresX;n++){for(var r=0;r<e.squaresY;r++){if(e.mineMap[n][r]===-1){var i=[n,n+1,n-1],s=[r,r+1,r-1];for(var u=0;u<3;u++){for(var a=0;a<3;a++){if(o.is("mine",i[u],s[a])){e.mineMap[i[u]][s[a]]++}}}e.totalMines++}}}},revealMines:function(r){for(var i=0;i<e.squaresX;i++){for(var s=0;s<e.squaresY;s++){if(e.mineMap[i][s]===-1){e.context.drawImage(r,i*t.celSize,s*t.celSize,t.celSize,t.celSize)}}}e.gameover=true;n.status.html("Game over :(");n.msg.html("Click the reset button to start a new game");window.clearInterval(e.clock)}};var s={standardBoard:function(){e.context.fillStyle=t.celColor;for(var n=0;n<=e.squaresX;n++){for(var r=0;r<=e.squaresY;r++){o.roundRect(n,r)}}},walker:function(){e.context.strokeStyle=t.celStroke;var n=[],r=[],i=[];for(var u=0;u<e.squaresX;++u){n[u]=~~(Math.random()*e.squaresX);r[u]=~~(Math.random()*2)+1;i[u]=~~(Math.random()*(e.squaresY/2-3))+3}e.currentAnimation=setInterval(function(){s.standardBoard();for(var t=0;t<e.squaresX;++t){for(var u=0;u<i[t];++u){e.context.fillStyle="rgba(66,139,202, "+.8*Math.pow(.8,u+2)+")";o.roundRect(t,(n[t]-u+e.squaresY)%e.squaresY)}}for(var t=0;t<e.squaresX;++t){n[t]+=r[t];n[t]%=e.squaresY}},80)}};var o={roundRect:function(n,r){var i=t.celSize-1,s=t.celSize-1,n=n*t.celSize,r=r*t.celSize;e.context.beginPath();e.context.moveTo(n+t.celRadius,r);e.context.lineTo(n+i-t.celRadius,r);e.context.quadraticCurveTo(n+i,r,n+i,r+t.celRadius);e.context.lineTo(n+i,r+s-t.celRadius);e.context.quadraticCurveTo(n+i,r+s,n+i-t.celRadius,r+s);e.context.lineTo(n+t.celRadius,r+s);e.context.quadraticCurveTo(n,r+s,n,r+s-t.celRadius);e.context.lineTo(n,r+t.celRadius);e.context.quadraticCurveTo(n,r,n+t.celRadius,r);e.context.closePath();e.context.stroke();e.context.fill()},switchScreens:function(){if($(".startscreen").is(":hidden")===false){$(".startscreen").fadeToggle(400,"swing",function(){r.reset();$(".gamescreen").fadeToggle()})}else{$(".gamescreen").fadeToggle(400,"swing",function(){r.reset();t.difficulty=0;$(".startscreen").fadeToggle()})}},is:function(t,n,r){var i={revealed:e.revealedMap,mine:e.mineMap,flag:e.flagMap};if(typeof i[t][n]!=="undefined"&&typeof i[t][n][r]!=="undefined"&&i[t][n][r]>-1){return true}else{return false}},save:function(){var n=JSON.stringify({elapsedTime:e.elapsedTime,firstClick:e.firstClick,flagMap:e.flagMap,mineMap:e.mineMap,revealedMap:e.revealedMap,totalFlags:e.totalFlags,totalMines:e.totalMines,difficulty:t.difficulty});var r=new Blob([n],{type:"application/json"});saveAs(r,"save.txt")},load:function(e){var t=e.originalEvent.target.files[0],n=new FileReader,r;n.onerror=o.loaderror;n.onload=function(e){if(e.target.readyState==FileReader.DONE){var t=e.target.result;r=JSON&&JSON.parse(t)||$.parseJSON(t);o.reload(r)}};n.readAsText(t)},loaderror:function(e){switch(e.target.error.code){case e.target.error.NOT_FOUND_ERR:alert("File Not Found!");break;case e.target.error.NOT_READABLE_ERR:alert("File is not readable");break;case e.target.error.ABORT_ERR:break;default:alert("An error occurred reading this file.")}},reload:function(i){r.reset();if($(".startscreen").is(":hidden")===false){$(".startscreen").fadeToggle(400,"swing",function(){$(".gamescreen").fadeToggle()})}t.difficulty=i.difficulty;if(i.firstClick)return;e.firstClick=i.firstClick;e.elapsedTime=i.elapsedTime;e.mineMap=i.mineMap;e.totalFlags=i.totalFlags;e.totalMines=i.totalMines;window.clearInterval(e.currentAnimation);s.standardBoard();r.timer();n.mines.html("You have to find "+e.totalMines+" mines to win.");o.reclick(i);o.reflag(i)},reclick:function(t){for(var n=0;n<e.squaresX;++n){for(var r=0;r<e.squaresY;++r){if(t.revealedMap[n][r]==1){i.index(n,r)}}}},reflag:function(n){var r=new Image;r.src=t.flagImg;r.onload=function(){for(var t=0;t<e.squaresX;++t){for(var s=0;s<e.squaresY;++s){if(n.flagMap[t][s]==1){i.flag(r,t,s)}}}}}};r.init()})